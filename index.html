<!DOCTYPE html>
  <head>
    <meta charset="utf-8">
    <title></title>
    <link rel="stylesheet" type="text/css" href="style.css">
  </head>
  <body>
	<p id="p">
		<label for="time">Time</label>
		<input style="width: 300px;" type="range" id="time" min="0" value="0" max="1440" step="1">
	</p>
	</p>
	<script src="https://d3js.org/d3.v4.min.js"></script>
	<script src="http://d3js.org/topojson.v2.min.js"></script>
	<script src="https://d3js.org/d3-geo.v1.min.js"></script>
	<script src="https://d3js.org/d3-geo-projection.v1.min.js"></script>
    <script>
	
	
   	var timeDict = {};
	weatherArray=[];	
	
	var parseTaxi = function(row){
		
	    dropLong = parseFloat(row.dropoff_longitude);
	    dropLat = parseFloat(row.dropoff_latitude);
	    dropTime = row.dropoff_datetime;
	    pickLong = parseFloat(row.pickup_longitude);
	    pickLat = parseFloat(row.pickup_latitude);
	    fare = parseFloat(row.payment_amount);
	    dist = parseFloat(row.trip_distance);
	  
	  var obj = { dropLong: dropLong, dropLat: dropLat, dropTime: dropTime, pickLong: pickLong, pickLat: pickLat, fare: fare, dist: dist};
      
	  var time = dropTime.split(' ')[1];
	  var slots =  time.split(':');
	  var tot = parseInt(slots[0])*60 + parseInt(slots[1]);
	  
	  if (!(tot in timeDict)){
		  timeDict[tot] = [obj];
	  }else {
		  timeDict[tot].push(obj);
	  }
	};
	
	var parseWeather = function(row){
        date = parseFloat(row.DATE);
        precip = parseFloat(row.PRCP);
        tempAve = parseFloat(row.TAVG);
        tempMax = parseFloat(row.TMAX);;
        tempMin = parseFloat(row.TMIN);;

        weatherArray.push({ date: date, precip: precip, tempAve: tempAve, 
			tempMax: tempMax, tempMin: tempMin });
	};
		
      
      d3.queue()
      .defer(d3.json, "nyc.json")
      .defer(d3.csv, "June5Taxi.csv", parseTaxi)
      .defer(d3.csv, "June8Taxi.csv", parseTaxi)
      .defer(d3.csv, "June12Taxi.csv", parseTaxi)
      .defer(d3.csv, "June15Taxi.csv", parseTaxi)
      .defer(d3.csv, "WeatherData.csv", parseWeather)
      .await(function (error, nyc, taxi5, taxi8, taxi12, taxi15, weather) {
        console.log("Code in the call-back function is only executed when every data file loads.");

		var svg = d3.select("#p").append("svg").attr("height",1100).attr("width",1000);
		
		var projection = d3.geoMercator().center([-73.94, 40.70])
				.scale(200000);
        
		projection.fitExtent([[0,0], [svg.attr("width"), svg.attr("height")]], nyc);
				
		var pathGenerator = d3.geoPath().projection(projection);
		var p = svg.append("g");
		
		p.selectAll(".state")
		.data(nyc.features)
		.enter().append("path")
		.attr("d", pathGenerator)
		.attr("transform", "translate(-600,200) rotate(-27)")
		.attr("fill","grey");

		p.selectAll(".state")
		.data(nyc.features)
		.enter().append("path")
		.attr("d", pathGenerator)
		.attr("transform", "translate(0,200) rotate(-27)")
		.attr("fill","grey");

		//Tooltip element for hover feature

		var tooltip = d3.select("body")
			.append("div")
			.attr("id", "tooltip")
			.style("position", "absolute")
			.style("z-index", "10")
			.style("visibility", "hidden")
			.text("");

		
		var slide = d3.select("#time");
		slide.on("input", function(){
			t = this.value;
			dropDots(t);
			pickDots(t);

		});

		function dropDots(t){
	     	var dropDots = svg.selectAll(".dropoffs").data(timeDict[t]);
			dropDots.exit().remove();
			dropDots.enter().append("circle").attr("class", "dropoffs").attr("r", 3).style("fill", "blue")
			.attr("cx", function(d) { 
				if ((d.dropLat > 1.895121486*d.dropLong+180.9002959) && (d.dropLat > .0550037105*d.dropLong+44.77000868) && (d.dropLat < 1.547301526*d.dropLong+155.2683443)){
					return projection([d.dropLong,d.dropLat])[0];
				}
			})
			.attr("cy", function(d) { 
				if ((d.dropLat > 1.895121486*d.dropLong+180.9002959) && (d.dropLat > .0550037105*d.dropLong+44.77000868) && (d.dropLat < 1.547301526*d.dropLong+155.2683443)){
					return projection([d.dropLong,d.dropLat])[1];
				}
			})
			.on("mouseover", function(d){return tooltip.style("visibility", "visible").text("Distance: " + d.dist +"\nFare: " + d.fare);})
			.on("mousemove", function(){return tooltip.style("top", (event.pageY-10)+"px").style("left", (event.pageX+10)+"px");})
			.on("mouseout", function(){return tooltip.style("visibility", "hidden");})
			.attr("transform", "translate(0,200) rotate(-27)");
		}



		

		function pickDots(t){
			var pickDots = svg.selectAll(".pickups").data(timeDict[t]);
			pickDots.exit().remove();
			pickDots.enter().append("circle").attr("class", "pickups").attr("r", 3).style("fill", "red")
			.attr("cx", function(d) { 
				if ((d.dropLat > 1.895121486*d.dropLong+180.9002959) && (d.dropLat > .0550037105*d.dropLong+44.77000868) && (d.dropLat < 1.547301526*d.dropLong+155.2683443)){
					return projection([d.pickLong,d.pickLat])[0];
				}
			})
			.attr("cy", function(d) { 
				if ((d.dropLat > 1.895121486*d.dropLong+180.9002959) && (d.dropLat > .0550037105*d.dropLong+44.77000868) && (d.dropLat < 1.547301526*d.dropLong+155.2683443)){
					return projection([d.pickLong,d.pickLat])[1];
				}
			})
			.on("mouseover", function(d){return tooltip.style("visibility", "visible").text("Distance: " + d.dist +"\nFare: " + d.fare);})
			.on("mousemove", function(){return tooltip.style("top", (event.pageY-10)+"px").style("left", (event.pageX+10)+"px");})
			.on("mouseout", function(){return tooltip.style("visibility", "hidden");})
			.attr("transform", "translate(-600,200) rotate(-27)");
		}


      });

      function distance(lat1, long1, lat2, long2){//returns distance in feet
        latDiff=lat1-lat2;
        latDiff=latDiff*364320 //364320=69 miles in feet, 1 degree of Lat is about 69 miles
        longDiff=long1-long2;
        longDiff=longDiff*279840 //279840=53 miles in feet, 1 degree of long is about 53 miles at 40 degrees north

        return Math.sqrt(Math.pow(latDiff, 2)+ Math.pow(longDiff, 2));
      }

      function taxiToInspect(taxi, maxDist){//returns closest business from inspectionArray to a taxi dropoff, or -1 if above max dist
        dropLat=taxi.dropLat;
        dropLong=taxi.dropLong;

        closestIndex=-1;
        dist=1000000000;
        for(i=0;i<inspectionArray.length;i++){
          //console.log("dist= "+dist);
          //console.log(distance(taxi.dropLat, taxi.dropLong, inspectionArray[i].latitude, inspectionArray[i].longitude));
		  var val = distance(taxi.dropLat, taxi.dropLong, inspectionArray[i].latitude, inspectionArray[i].longitude);
          if(val<dist){
            closestIndex=i;
            dist=val;
          }
        }
		
        if (closestIndex <= maxDist){
          return inspectionArray[closestIndex];
        }
        else{
          return -1;
        }
      }
    </script>
  </body>
</html>